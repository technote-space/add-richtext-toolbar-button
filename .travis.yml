language: php

sudo: false
dist: trusty

notifications:
  email: false
  slack:
    secure: hkI7HympYUnAUR6VeybsrtTKnoOz8PNxe2FtfvHsnBuCSkxwfuF5nhmfagn54ncj/9KIlmU3eP3+8WI3WrUTZMHN+vhIg6H6Z5i8JxicHNRGUFSPEoCNca1hzsoP3zCN/IB71NfTkCTxAtW8+1dPKP/85rWcoiyG6DRP5+0eK1tEKNf/h9MeF4ItVd46VEwPqiyW6aofPMNHBohkvIILY0lMudgD+WB0Sbp2fBY+SHj2zdnt92IeLUXfwzglGGezrq5Z/1PwDhf5AUGshhj5VYWIs8l9v0FetRsBRutKq1G1YDdBO7DIln+AT70WYzEkJtDcc3WBExxMqBP6KrJvPf/M5peGCoVCqgtAB2mPOXMEnAhMdxspmL8Rmh9cbhMZPsiilyagUqm24aCvDLIoGRKFw1H2no9LzK5gimmBCynJIzfJpICM9h1L0aSOj4uJKUJwOLqfJtzleNLcsUTOjsdA9beZeBqg6HflTx5ah+LhQKPQPQFHBxmNxHj/eThvxOiXsc+Q3sHkzR9uCO8kt9Jpyua5d0YBIhbvYoNzVABiHxSxXU0YTxoMoq7+yvg6peVE3FIoNE+Ks4fgrD5/nkmosrj/z9AQox0iFfJj1HvZKoTQQUt/HQM/uyLzMcKWpd+5f71F/JwCJzV4K41WRfbV56yuZ/cFEknbwJSXyEo=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  directories:
    - "$HOME/.composer/cache"
    - "$HOME/.npm"

stages:
  - name: check
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: test
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: prepare
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: deploy
    if: tag IS present

before_script:
  - git clone --depth=1 https://github.com/wp-content-framework/travis-ci.git travis-ci
  - bash travis-ci/bin/prepare.sh

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash travis-ci/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env: WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env: WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env:
        - WP_VERSION=5.1
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.9
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=3.9
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash travis-ci/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash travis-ci/bin/js/js-test.sh


    - stage: prepare
      language: node_js
      node_js: '11'
      dist: trusty
      script:
        - source travis-ci/bin/deploy/env.sh
        - bash travis-ci/bin/deploy/wp-check-diff.sh


    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source travis-ci/bin/deploy/env.sh
        - bash travis-ci/bin/deploy/create.sh
      deploy:
        provider: releases
        skip_cleanup: true
        name: ${RELEASE_TITLE}
        tag_name: ${RELEASE_TAG}
        draft: true
        api_key:
          secure: 0zDtdoGAy8qUSY55bqNmxXWYiQjz9o+SHzYF5E99MLCwRzTy1Tk5lbpz7CS+bS8FWq1azIsCUAyPKpFJNF1NVYQnbfU8lOGtnyRcxCxQoy//dRJCyBIa4Ai8i22jkjVV7oNyonXAcTaN77ZN/1RXzpU9lo5hqWq7JrgkvkRdvLp7u+2zJZLyJzmpUJ4Khcus4/uZPI0QMJwOucOqcd/buDEkjpgnUv2tRnmHBOFUN8dvn4TAlAeQutNt73xUFmEam3Li90oK8rJdauxg4p3x+6aTcDyL/Ibmq/RSHIbhb1tg8iokLFudfjspDn1gvx9f8Efdn3eShwC+DIVMd0iZjETZbJXK0r4ozvwZakThS5fPXVHjeWvNJ3eZJJN4NU3kBAP9Yd7jd0d/vOroeSrba1VGXeOzWv5TTXvVNQPwgmDSS9/mVZcxsh3eCdc37Tay/FnYsbTJd24nMmNCeXx3/ThmE7gqL47bWS+G0zovYKndw5prgi15RK9+May6nYXQLvv63KLae3L8naD10rC71Q0e4GuXk8GjVDrPGj1zcSoPLBljTq1s2VzkVMUXW7zhiBHxxIH9WAXmGd1q1eKNjJJkDhucAPU2DKd3LT+/msK9EgWUcc/6OLRkJiokzBFO2brgOD0IdbKAApb5bo7OMumbJjkQu1jJISp8FSBP8os=
        file: ${RELEASE_FILE}
        overwrite: true
        on:
          tags: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source travis-ci/bin/deploy/env.sh
      deploy:
        provider: script
        skip_cleanup: true
        script: bash travis-ci/bin/deploy/wp-release.sh
        on:
          tags: true

  allow_failures:
    - env: WP_VERSION=4.9
    - env: WP_VERSION=3.9

language: php

sudo: false
dist: trusty

git:
  depth: 3

notifications:
  email: false
  slack:
    secure: g5FDqjTLfWRVIkTefDo1Qolh02RvXTj73b4r6nFhyad7ESMZV0AVk5q6Y5G3eU2sBcnzNYb6XU/7Pm0GEYN4WcGPirWDS24GgE/pFpnDj8ooxYVeGOGvRn1ROmsTG1Iodv2mcEwnusCf4TzIPwQsCzoqrH8YkNGXcxWOSaatolvAHrmzq0o9TJ0NHoPr0vUC8tGxg7D1JqQ+5INCcIOK2JZQf0LZySUYixTgbRx71wZJa60vnbye9A7LPDajJYqnbt3KAQ8M6Q/k3bhIvd5mkdZzmsj3o2tdCpNdKx2wi9l3Z39C5haVyBLuM3/m3UI8keWNkKnBnx7VY33eMcYyrSFrfM9lQMxWhXHicOLeelIE3TS51A30ISH53vo/9NBSjjybas3EIOqKj8mzMbuz2unODB8aRcfBE+3h818dI/K2GdKkrzvleAIyqoWEGrkjlTz8ChcxMQjyk3lTieGwYw5UDgmqAeRrwxfaYl+YupN0Un38PEwrbf+PfhaWEunUMjPqvfw5SJl+BqGDQtaDFAvTKo7m1Phi/K4BzB5+WhgAexi+L0tDvStUZREBnYf+JOiMaAfAVz1ufRwzkc24arLn4xmgfPUHzSy5r5evGUcvr8GClF/iKGo9l57K3l6dsatIb7RfWE3ywO4DBHo+B/0d3ue7szBHCppAo49Ub2A=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  yarn: true
  directories:
    - "${HOME}/.composer/cache"
    - node_modules

stages:
  - name: check
    if: branch = master and tag IS blank and type IN (pull_request, api, cron)
  - name: test
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: test trunk
    if: branch = master and tag IS blank and type IN (pull_request, api, cron)

before_script:
  - git clone --depth=1 https://github.com/wp-content-framework/travis-ci.git travis-ci
  - bash travis-ci/bin/prepare.sh

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash travis-ci/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash travis-ci/bin/js/js-test.sh


    - stage: test trunk
      language: php
      php: '7.3'
      env:
        - WP_VERSION=trunk
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test trunk
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash travis-ci/bin/php/wp-test.sh
